<ui:composition template="/templates/contextTemplate.xhtml" xmlns="http://www.w3.org/1999/xhtml"
                xmlns:ui="http://java.sun.com/jsf/facelets"
                xmlns:h="http://java.sun.com/jsf/html"
                xmlns:p="http://primefaces.org/ui"
                xmlns:c="http://java.sun.com/jsp/jstl/core"
                xmlns:f="http://java.sun.com/jsf/core">
    <ui:param name="titulotab" value="Running History" />
    <ui:define name="body">
        <h:panelGroup id="formRun">
            <h:panelGroup rendered="#{newRunBean.toRun==null}">
                <h:outputLabel value="Select a platform:" style="padding-bottom: 10px;"/>
                <h:panelGrid columns="6">
                    <c:forEach items="#{platformBean.lista}" var="p">
                        <p:commandLink action="#{newRunBean.selectPlatform(p.id)}" ajax="true" update="formRun" style="text-align: center;text-decoration: none;">
                            <h:graphicImage value="/resources/platform-logos/${p.image}" height="50px" />
                            <h:outputLabel style="display: block;font-weight: bold;cursor: pointer;" value="${p.name}" />
                        </p:commandLink>
                    </c:forEach>
                </h:panelGrid>
            </h:panelGroup>
            <h:panelGrid columnClasses="alignTop,alignTop" columns="2" rendered="#{newRunBean.toRun!=null}" style="min-width: 500px;">
                <p:commandButton value="Back" action="#{newRunBean.selectPlatform(-1)}" update="formRun"/>
                <h:panelGroup>
                    <h:form id="mainForm">
                        <h:panelGrid columns="3" style="width: 100%;" columnClasses="alignTop,alignRightTop,alignRightTop" cellspacing="0" cellpadding="0">
                            <h:panelGrid columns="2" cellspacing="0" cellpadding="0" >
                                <h:outputLabel value="Platform:" style="width: 100px;display: block;" />
                                <h:outputText value="${newRunBean.toRun.platform.name}" />
                                <h:outputLabel value="Execution name:" style="width: 100px;display: block;" />
                                <h:inputText value="#{newRunBean.toRun.runName}" style="width: 200px;" />
                                <h:outputLabel value="Recovery mode:" style="display: block;padding-top: 10px;"/>
                                <p:selectOneMenu style="width: 200px;display: block;"  >
                                    <f:selectItem itemLabel="Platform stop" itemValue="" />  
                                    <f:selectItem itemLabel="Platform checkpointing" itemValue="2" />  
                                    <f:selectItem itemLabel="Platform relaunch" itemValue="3" />
                                </p:selectOneMenu>
                            </h:panelGrid>
                            <h:graphicImage value="/resources/platform-logos/${newRunBean.toRun.platform.image}" height="50px" />
                            <h:commandButton image="/resources/startButton.png" action="#{newRunBean.startPlatform()}" />
                        </h:panelGrid>
                        <h:panelGroup rendered="#{newRunBean.toRun.platform.mainCommand ne null}" >

                            <h:outputLabel value="Main command:" style="display: block;padding-top: 10px;"/>
                            <h:panelGrid style="padding-left: 5px;" columns="2" cellspacing="0" cellpadding="0" >
                                <h:outputLabel value="Command:" style="width: 100px;display: block;" />
                                <h:panelGrid columns="2" cellspacing="0" cellpadding="0" >
                                    <h:outputText value="#{newRunBean.toRun.platform.mainCommand.command}" style="padding-right: 10px;"/>
                                    <h:inputText style="width: 500px;" value="#{newRunBean.mainCommandArgs}" />
                                </h:panelGrid>
                                <h:outputLabel value="Target role:" />
                                <h:outputText value="#{newRunBean.toRun.platform.mainCommand.roleId}"/>
                                <h:outputLabel value="Multiplicity:" />
                                <h:outputText value="#{newRunBean.toRun.platform.mainCommand.multiplicity.id}"/>
                                <h:outputLabel value="Type:" />
                                <h:outputText value="#{newRunBean.toRun.platform.mainCommand.resourceType}"/>
                            </h:panelGrid>
                        </h:panelGroup>
                        <h:outputLabel value="Roles:" style="display: block;padding-top: 10px;"/>
                        <ui:repeat id="rolesTable" value="#{newRunBean.toRun.roles}" var="role">
                            <p:panel id="rol#{role.roleConfig.roleName}" header="Role: #{role.roleConfig.roleName}" toggleable="true" collapsed="true" >
                                <h:panelGrid columns="2">
                                    <h:outputLabel value="Multiplicity:" />
                                    <h:outputText value="#{role.roleConfig.multiplicityString}"/>
                                    <h:outputLabel value="Modules:" />
                                    <h:panelGroup>
                                        <h:outputText value="#{role.roleConfig.puppetModule.puppetmodule.name}, "/>
                                        <ui:repeat var="module" value="#{role.puppetModules}">
                                            <h:outputText value="#{module.puppetmodule.name}, "/>
                                        </ui:repeat>
                                        <p:commandLink value="Add..." ajax="true" action="#{newRunBean.addNewModule(role.roleConfig.roleName)}" oncomplete="addModuleDialogWv.show();" />
                                    </h:panelGroup>
                                    <h:outputLabel value="Cores:" />
                                    <p:spinner value="#{role.cores}" min="1" max="40" size="3"/>
                                    <h:outputLabel value="Cores Per Node:" />
                                    <p:spinner value="#{role.coresPerNode}" min="1" max="8" size="3"/>
                                </h:panelGrid>
                                <h:outputLabel value="Commands:" />
                                <p:dataTable value="#{role.commandExecutions}" var="com" style="width: 100%;">
                                    <p:column headerText="Command">
                                        <h:outputLabel value="#{com.mainCommand?'MAIN COMMAND':com.command}"/>
                                    </p:column>
                                    <p:column headerText="Multiplicity">
                                        <h:outputLabel value="#{com.multiplicity}"/>
                                    </p:column>
                                    <p:column headerText="Type">
                                        <h:outputLabel value="#{com.resourceType}"/>
                                    </p:column>
                                </p:dataTable>
                            </p:panel>
                        </ui:repeat>
                        <h:outputLabel value="Files:" style="display: block;padding-top: 10px;"/>
                        <p:dataTable id="fileTable" value="#{newRunBean.files}" var="f">
                            <p:column headerText="File name">
                                <h:outputText value="#{f.name}"/>
                            </p:column>
                            <p:column headerText="Path">
                                <h:outputText value="#{f.path}"/>
                            </p:column>
                            <p:column headerText="Type">
                                <h:outputText value="#{f.fileType}"/>
                            </p:column>
                            <p:column headerText="Role">
                                <h:outputText value="#{f.global?'-':'R'}"/>
                            </p:column>
                            <p:column headerText="Options">
                                <p:selectBooleanCheckbox label="Unzip" rendered="#{f.name.endsWith('.zip')}" value="#{f.unzip}" /><h:outputText style="padding-left: 5px;" rendered="#{f.name.endsWith('.zip')}" value="unzip" />
                            </p:column>
                        </p:dataTable>
                    </h:form>
                    <h:outputLabel value="Add files:" style="display: block;padding-top: 10px;"/>
                    <p:commandButton ajax="true" value="Add UnaCloud file" onclick="addUCFileDialogWv.show();"/>
                    <h:form enctype="multipart/form-data">
                        <p:fileUpload fileUploadListener="#{newRunBean.handleFileUpload}"  
                                      mode="advanced"  
                                      update=":mainForm:fileTable"
                                      label="Add local files"
                                      auto="true"
                                      multiple="true"  
                                      sizeLimit="100000000"   />  
                    </h:form>
                </h:panelGroup>
            </h:panelGrid>
        </h:panelGroup>
        <p:dialog header="Add new module" id="addModuleDialog" widgetVar="addModuleDialogWv" width="400px">
            <h:form>
                <p:autoComplete widgetVar="autoCompleteModules" value="#{newRunBean.puppetModule}" id="basic" completeMethod="#{newRunBean.completeModule}"  
                                var="p" itemLabel="#{p.name}" itemValue="#{p}" converter="puppetmoduleconverter" forceSelection="true"> 
                    <p:ajax event="itemSelect" update="dataModule" />
                </p:autoComplete>
                <h:panelGroup id="dataModule" style="width: 100%;">
                    <h:panelGrid columns="2">
                        <h:outputLabel value="Name" />
                        <h:outputText value="#{newRunBean.puppetModule.name}" />
                        <h:outputLabel value="Description" />
                        <h:outputText value="#{newRunBean.puppetModule.descripcion}" />
                    </h:panelGrid>
                    <h:panelGrid columns="2" style="float: right;">
                        <p:commandButton value="Cancel" action="#{newRunBean.clear()}" onclick="addModuleDialogWv.hide();"/>
                        <p:commandButton value="Add" action="#{newRunBean.addModule()}"/>
                    </h:panelGrid>
                </h:panelGroup>
            </h:form>
        </p:dialog>
        <p:dialog header="Add UnaCloud File" id="addUCFileDialog" widgetVar="addUCFileDialogWv">
            <h:form>
                <p:dataTable id="fileTable" value="#{fileSystemBean.list}" var="file">
                    <p:column headerText="Name">
                        <h:outputText value="#{file.name}"/>
                    </p:column>
                    <p:column headerText="Path">
                        <h:outputText value="#{file.path}"/>
                    </p:column>
                    <p:column headerText="Options">
                        <p:commandButton value="select" ajax="true" action="#{newRunBean.addLocalFile(file.path,file.name)}" update=":mainForm:fileTable" oncomplete="addUCFileDialogWv.hide();" />
                    </p:column>
                </p:dataTable>
            </h:form>
        </p:dialog>
    </ui:define>
</ui:composition>
